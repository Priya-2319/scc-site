{% extends "student_side/student_base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="announcement-header text-center mb-5">
        <h1 class="display-5 fw-bold mb-3" style="color: rgb(223, 47, 176);"><i class="fas fa-credit-card me-2"></i> Make Payments</h1>
        <p class="lead" style="color: rgb(200, 207, 19);">Secure payment processing for your courses.</p>
    </div>
    
    <!-- Payment History Button -->
    <div class="d-flex justify-content-end mb-4">
        <a href="{{ url_for('payment_history') }}" class="btn btn-payment-history">
            <i class="fas fa-history me-2"></i>View Payment History
        </a>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Course Selection -->
            <div class="card payment-card mb-4">
                <div class="card-header payment-card-header">
                    <h4 class="payment-card-title"><i class="fas fa-book me-2"></i>Select Course</h4>
                </div>
                <div class="card-body">
                    <div class="form-floating">
                        <select class="form-select" id="course-select">
                            <option value="">-- Select Course --</option>
                            {% for course in courses %}
                            <option value="{{ course.course_id }}" 
                                    data-monthly-fee="{{ course.monthly_fee }}"
                                    data-full-fee="{{ course.full_fee }}"
                                    data-duration="{{ course.duration_months }}">
                                {{ course.course_name }} (₹{{ course.monthly_fee }}/month)
                            </option>
                            {% endfor %}
                        </select>
                        <label for="course-select">Choose your course</label>
                    </div>
                </div>
            </div>

            <!-- Payment Options -->
            <div class="row g-4">
                <!-- Current Month Payment -->
                <div class="col-md-6">
                    <div class="card payment-option-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="payment-icon me-3">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <h5 class="payment-option-title mb-0">Current Month</h5>
                            </div>
                            <p class="payment-amount">₹<span id="current-month-amount">0</span></p>
                            <button class="btn btn-payment w-100" id="pay-current-month" disabled>
                                <i class="fas fa-credit-card me-2"></i>Pay Now
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Full Course Payment -->
                <div class="col-md-6">
                    <div class="card payment-option-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="payment-icon me-3">
                                    <i class="fas fa-certificate"></i>
                                </div>
                                <h5 class="payment-option-title mb-0">Full Course</h5>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <p class="payment-amount mb-0">₹<span id="full-course-amount">0</span></p>
                                <span class="badge bg-savings">
                                    Save ₹<span id="discount-amount">0</span>
                                </span>
                            </div>
                            <button class="btn btn-payment w-100" id="pay-full-course" disabled>
                                <i class="fas fa-money-bill-wave me-2"></i>Pay Full Amount
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Select Month Payment -->
                <div class="col-12">
                    <div class="card payment-option-card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <div class="d-flex align-items-center">
                                        <div class="payment-icon me-3">
                                            <i class="fas fa-calendar-check"></i>
                                        </div>
                                        <h5 class="payment-option-title mb-0">Select Month</h5>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3 mb-md-0">
                                    <select class="form-select" id="month-select">
                                        {% for month in next_months %}
                                        <option value="{{ month }}">{{ month }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex align-items-center justify-content-md-end">
                                        <p class="payment-amount mb-0 me-3">₹<span id="selected-month-amount">0</span></p>
                                        <button class="btn btn-payment" id="pay-selected-month" disabled>
                                            <i class="fas fa-calendar-plus me-2"></i>Pay
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- UPI QR Modal -->
<div class="modal fade" id="upiQrModal" tabindex="-1" aria-labelledby="upiQrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upiQrModalLabel">Scan QR Code to Pay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qr-code-container">
                    <img id="upi-qr-image" src="" alt="UPI QR Code" class="img-fluid mb-3" style="max-width: 300px;">
                    <p class="text-muted mb-3">Scan this QR code using any UPI app to complete your payment</p>
                    <div class="d-flex justify-content-center mb-3">
                        <div class="spinner-border text-primary" role="status" id="qr-spinner">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="payment-status-message" class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>Waiting for payment confirmation...
                    </div>
                </div>
                <div id="payment-success-container" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Payment successful!
                    </div>
                    <button id="success-continue-btn" class="btn btn-success">
                        <i class="fas fa-arrow-right me-2"></i>Continue
                    </button>
                </div>
                <div id="payment-failed-container" style="display: none;">
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>Payment failed or was cancelled
                    </div>
                    <button id="failed-retry-btn" class="btn btn-primary me-2">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                    <button id="failed-cancel-btn" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const courseSelect = document.getElementById('course-select');
    const currentMonthAmount = document.getElementById('current-month-amount');
    const fullCourseAmount = document.getElementById('full-course-amount');
    const selectedMonthAmount = document.getElementById('selected-month-amount');
    const discountAmount = document.getElementById('discount-amount');
    const payButtons = {
        current_month: document.getElementById('pay-current-month'),
        full_course: document.getElementById('pay-full-course'),
        selected_month: document.getElementById('pay-selected-month')
    };
    
    // Modal Elements
    const upiQrModal = new bootstrap.Modal(document.getElementById('upiQrModal'));
    const upiQrImage = document.getElementById('upi-qr-image');
    const qrSpinner = document.getElementById('qr-spinner');
    const paymentStatusMessage = document.getElementById('payment-status-message');
    const paymentSuccessContainer = document.getElementById('payment-success-container');
    const paymentFailedContainer = document.getElementById('payment-failed-container');
    const successContinueBtn = document.getElementById('success-continue-btn');
    const failedRetryBtn = document.getElementById('failed-retry-btn');
    const failedCancelBtn = document.getElementById('failed-cancel-btn');
    
    // State variables
    let currentPaymentData = null;
    let paymentPollInterval = null;
    let currentPaymentType = null;
    let currentButton = null;
    
    // Course selection handler
    courseSelect.addEventListener('change', updatePaymentDetails);
    
    // Payment button handlers
    Object.entries(payButtons).forEach(([type, button]) => {
        button.addEventListener('click', () => {
            currentPaymentType = type;
            currentButton = button;
            handlePayment(type);
        });
    });
    
    // Modal button handlers
    successContinueBtn.addEventListener('click', () => {
        upiQrModal.hide();
        window.location.href = '/payment/success';
    });
    
    failedRetryBtn.addEventListener('click', () => {
        upiQrModal.hide();
        if (currentPaymentType && currentButton) {
            handlePayment(currentPaymentType);
        }
    });
    
    failedCancelBtn.addEventListener('click', () => {
        upiQrModal.hide();
        resetButtonState(currentButton, getButtonText(currentPaymentType));
    });
    
    // Update payment details when course changes
    function updatePaymentDetails() {
        const selectedOption = courseSelect.options[courseSelect.selectedIndex];
        const monthlyFee = selectedOption?.dataset.monthlyFee;
        const fullFee = selectedOption?.dataset.fullFee;
        const duration = selectedOption?.dataset.duration || 12;
    
        if (monthlyFee && fullFee) {
            const monthlyNum = parseFloat(monthlyFee);
            const fullNum = parseFloat(fullFee);
            const discount = (monthlyNum * duration) - fullNum;
            
            currentMonthAmount.textContent = monthlyFee;
            fullCourseAmount.textContent = fullFee;
            selectedMonthAmount.textContent = monthlyFee;
            discountAmount.textContent = discount > 0 ? discount.toFixed(2) : '0';
            
            // Enable all buttons
            Object.values(payButtons).forEach(btn => btn.disabled = false);
        } else {
            // Disable all buttons
            Object.values(payButtons).forEach(btn => btn.disabled = true);
        }
    }
    
    // Handle payment initiation
    async function handlePayment(paymentType) {
        const courseId = courseSelect.value;
        if (!courseId) {
            alert('Please select a course first');
            return;
        }
    
        const button = payButtons[paymentType];
        const originalText = button.innerHTML;
        
        try {
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
            button.disabled = true;
    
            const payload = {
                payment_type: paymentType,
                course_id: courseId
            };
    
            if (paymentType === 'selected_month') {
                payload.selected_month = document.getElementById('month-select').value;
            }
    
            const response = await fetch('/initiate-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });
    
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (data.error) throw new Error(data.error);
            
            currentPaymentData = data;
            
            // Check if this is a UPI QR code payment
            if (data.upi_qr_code) {
                showUpiQrModal(data);
            } else {
                initializeRazorpay(data, button);
            }
    
        } catch (error) {
            console.error('Payment error:', error);
            alert(error.message || 'Payment initialization failed');
            resetButtonState(button, originalText);
        }
    }
    
    // Show UPI QR modal and start polling
    function showUpiQrModal(data) {
        // Reset modal state
        qrSpinner.style.display = 'block';
        upiQrImage.style.display = 'none';
        paymentStatusMessage.style.display = 'block';
        paymentSuccessContainer.style.display = 'none';
        paymentFailedContainer.style.display = 'none';
        
        // Set QR code image
        upiQrImage.src = data.upi_qr_code;
        upiQrImage.onload = () => {
            qrSpinner.style.display = 'none';
            upiQrImage.style.display = 'block';
        };
        
        // Show modal
        upiQrModal.show();
        
        // Start polling for payment status
        startPaymentPolling(data.order_id, data.internal_ref);
    }
    
    // Start polling for payment status
    function startPaymentPolling(orderId, internalRef) {
        // Clear any existing interval
        if (paymentPollInterval) {
            clearInterval(paymentPollInterval);
        }
        
        // Start new polling
        paymentPollInterval = setInterval(() => {
            checkPaymentStatus(orderId, internalRef);
        }, 3000); // Poll every 3 seconds
        
        // Initial check
        checkPaymentStatus(orderId, internalRef);
    }
    
    // Check payment status with server
    async function checkPaymentStatus(orderId, internalRef) {
        try {
            const response = await fetch('/check-payment-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    internal_ref: internalRef
                })
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (data.status === 'completed') {
                // Payment completed
                clearInterval(paymentPollInterval);
                showPaymentSuccess();
            } else if (data.status === 'failed') {
                // Payment failed
                clearInterval(paymentPollInterval);
                showPaymentFailed();
            }
            // Continue polling if status is pending
            
        } catch (error) {
            console.error('Payment status check error:', error);
            // Don't stop polling on network errors
        }
    }
    
    // Show payment success in modal
    function showPaymentSuccess() {
        paymentStatusMessage.style.display = 'none';
        paymentSuccessContainer.style.display = 'block';
    }
    
    // Show payment failed in modal
    function showPaymentFailed() {
        paymentStatusMessage.style.display = 'none';
        paymentFailedContainer.style.display = 'block';
    }
    
    // Initialize Razorpay for non-UPI payments
    function initializeRazorpay(data, button) {
        const options = {
            key: data.key_id,
            amount: data.amount,
            currency: 'INR',
            name: "Science Coaching Center",
            description: `Payment for ${data.course_name}`,
            order_id: data.order_id,
            handler: async (response) => {
                try {
                    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Verifying...';
                    const verification = await fetch(data.callback_url, {
                        method: 'POST',
                        body: new URLSearchParams({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature
                        })
                    });
                    
                    const result = await verification.json();
                    
                    if (result.status === 'success') {
                        window.location.href = result.redirect_url;
                    } else {
                        throw new Error(result.message || 'Payment verification failed');
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    alert(error.message);
                    window.location.href = '/payment/failed';
                } finally {
                    resetButtonState(button, getButtonText(currentPaymentType));
                }
            },
            modal: {
                ondismiss: () => resetButtonState(button, getButtonText(currentPaymentType))
            },
            theme: {
                color: "#3399cc"
            }
        };
    
        const rzp = new Razorpay(options);
        rzp.open();
    }
    
    // Reset button to original state
    function resetButtonState(button, text) {
        if (button) {
            button.disabled = false;
            button.innerHTML = text;
        }
    }
    
    // Get button text based on payment type
    function getButtonText(paymentType) {
        switch(paymentType) {
            case 'current_month':
                return '<i class="fas fa-credit-card me-2"></i>Pay Now';
            case 'full_course':
                return '<i class="fas fa-money-bill-wave me-2"></i>Pay Full Amount';
            case 'selected_month':
                return '<i class="fas fa-calendar-plus me-2"></i>Pay';
            default:
                return 'Pay Now';
        }
    }
});
</script>

<style>
    /* All your existing styles remain the same */
    .announcement-header {
        animation: fadeInDown 0.8s ease;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .animate-gradient {
            font-size: 1.8rem;
            animation-duration: 6s;
        }
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #6a1b9a, #9c27b0);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }
    
    .payment-subtitle {
        color: #6c757d;
        font-size: 1.1rem;
    }
    
    /* Cards */
    .payment-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s ease;
    }
    
    .payment-card:hover {
        transform: translateY(-5px);
    }
    
    .payment-card-header {
        background: linear-gradient(135deg, #343a40, #495057);
        color: white;
        border-radius: 12px 12px 0 0 !important;
        padding: 1rem 1.5rem;
    }
    
    .payment-card-title {
        margin-bottom: 0;
        font-size: 1.2rem;
    }
    
    /* Payment Options */
    .payment-option-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .payment-option-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .payment-icon {
        width: 48px;
        height: 48px;
        background: rgba(106, 27, 154, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6a1b9a;
        font-size: 1.25rem;
    }
    
    .payment-option-title {
        font-weight: 600;
        color: #343a40;
    }
    
    .payment-amount {
        font-size: 1.75rem;
        font-weight: 700;
        color: #6a1b9a;
        margin: 1rem 0;
    }
    
    /* Buttons */
    .btn-payment-history {
        background: #6a1b9a;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-payment-history:hover {
        background: #9c27b0;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(154, 27, 154, 0.2);
    }
    
    .btn-payment {
        background: linear-gradient(135deg, #6a1b9a, #9c27b0);
        color: white;
        border: none;
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-payment:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(154, 27, 154, 0.3);
    }
    
    .btn-payment:disabled {
        background: #e9ecef;
        color: #6c757d;
        transform: none;
        box-shadow: none;
    }
    
    /* Badge */
    .bg-savings {
        background-color: #fff3cd;
        color: #856404;
        font-weight: 500;
        padding: 0.35em 0.65em;
        border-radius: 50px;
    }
    
    /* Form Elements */
    .form-floating label {
        color: #6c757d;
    }
    
    .form-select {
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
    }
    
    .form-select:focus {
        border-color: #9c27b0;
        box-shadow: 0 0 0 0.25rem rgba(156, 39, 176, 0.25);
    }
    
    /* Modal Styles */
    #upiQrModal .modal-content {
        border-radius: 15px;
        overflow: hidden;
    }
    
    #upiQrModal .modal-header {
        background: linear-gradient(135deg, #6a1b9a, #9c27b0);
        color: white;
    }
    
    #upiQrModal .btn-close {
        filter: invert(1);
    }
    
    /* Responsive Adjustments */
    @media (max-width: 767.98px) {
        .payment-option-title {
            font-size: 1rem;
        }
        
        .payment-amount {
            font-size: 1.5rem;
        }
        
        .btn-payment {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}